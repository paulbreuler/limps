name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.2.0)'
        required: true
        type: string

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm test

      - name: Verify build
        run: npm run build

  build-and-release:
    needs: validate
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node-version: [20.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build
        run: npm run build

      - name: Create release archive
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          if [ -z "$VERSION" ]; then
            VERSION=${{ github.event.inputs.version }}
          fi
          
          # Create archive name based on OS
          if [ "$RUNNER_OS" == "Windows" ]; then
            ARCHIVE_NAME="limps-${VERSION}-windows-x64"
            ARCHIVE_EXT=".zip"
          elif [ "$RUNNER_OS" == "macOS" ]; then
            ARCHIVE_NAME="limps-${VERSION}-macos-x64"
            ARCHIVE_EXT=".tar.gz"
          else
            ARCHIVE_NAME="limps-${VERSION}-linux-x64"
            ARCHIVE_EXT=".tar.gz"
          fi
          
          # Create archive with built files and necessary configs
          mkdir -p release
          cp -r dist release/
          cp package.json release/
          cp config.json.example release/config.json.example
          cp README.md release/
          cp INSTALLATION.md release/
          cp SETUP_CURSOR.md release/
          cp LICENSE release/ 2>/dev/null || true
          
          # Create archive
          if [ "$RUNNER_OS" == "Windows" ]; then
            cd release
            powershell Compress-Archive -Path * -DestinationPath "../${ARCHIVE_NAME}${ARCHIVE_EXT}"
            cd ..
          else
            tar -czf "${ARCHIVE_NAME}${ARCHIVE_EXT}" -C release .
          fi
          
          echo "ARCHIVE_NAME=${ARCHIVE_NAME}${ARCHIVE_EXT}" >> $GITHUB_ENV
          echo "ARCHIVE_PATH=${ARCHIVE_NAME}${ARCHIVE_EXT}" >> $GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARCHIVE_NAME }}
          path: ${{ env.ARCHIVE_PATH }}
          retention-days: 30

  create-release:
    needs: [validate, build-and-release]
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.version != ''
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for tag comparison

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "TAG=${VERSION}" >> $GITHUB_OUTPUT

      - name: Get previous tag
        id: previous_tag
        run: |
          CURRENT_TAG="${{ steps.version.outputs.TAG }}"
          
          # Get all tags sorted by version (semantic versioning)
          PREVIOUS_TAG=$(git tag -l 'v*' | sort -V | grep -B1 "^${CURRENT_TAG}$" | head -1 || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "PREVIOUS_TAG=" >> $GITHUB_OUTPUT
            echo "IS_FIRST_RELEASE=true" >> $GITHUB_OUTPUT
            echo "No previous tag found - this appears to be the first release"
          else
            echo "PREVIOUS_TAG=${PREVIOUS_TAG}" >> $GITHUB_OUTPUT
            echo "IS_FIRST_RELEASE=false" >> $GITHUB_OUTPUT
            echo "Previous tag: ${PREVIOUS_TAG}"
          fi

      - name: Generate and prepare release notes
        id: release_notes
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const version = '${{ steps.version.outputs.VERSION }}';
            const previousTag = '${{ steps.previous_tag.outputs.PREVIOUS_TAG }}';
            const repo = context.repo;
            
            let releaseName;
            let releaseBody;
            
            try {
              // Generate release notes using GitHub API
              const { data } = await github.rest.repos.generateReleaseNotes({
                owner: repo.owner,
                repo: repo.repo,
                tag_name: '${{ steps.version.outputs.TAG }}',
                target_commitish: 'main',
                previous_tag_name: previousTag || undefined,
                configuration_file_path: '.github/release.yml'
              });
              
              releaseName = data.name;
              releaseBody = data.body;
              console.log('Successfully generated release notes from GitHub API');
            } catch (error) {
              console.log('Failed to generate release notes, using fallback:', error.message);
              releaseName = `Release ${version}`;
              releaseBody = `## Pre-built Release

This release includes pre-built binaries for:
- Linux (x64)
- macOS (x64)
- Windows (x64)

### Installation

1. Download the archive for your platform
2. Extract the archive
3. Edit \`config.json.example\` and rename it to \`config.json\`
4. Update paths in \`config.json\` to point to your planning documents
5. Configure Cursor (see \`SETUP_CURSOR.md\`)

### Usage

Run the server:
\`\`\`bash
node dist/index.js
\`\`\`

Or configure Cursor to use it automatically.

See [INSTALLATION.md](https://github.com/${repo.owner}/${repo.repo}/blob/main/INSTALLATION.md) for detailed instructions.`;
            }
            
            // Combine generated notes with installation instructions
            const installationSection = `

---

## ðŸ“¦ Pre-built Release

This release includes pre-built binaries for:
- **Linux** (x64) - \`limps-${version}-linux-x64.tar.gz\`
- **macOS** (x64) - \`limps-${version}-macos-x64.tar.gz\`
- **Windows** (x64) - \`limps-${version}-windows-x64.zip\`

### Quick Installation

1. Download the archive for your platform from the assets above
2. Extract the archive
3. Copy \`config.json.example\` to \`config.json\` and edit paths to point to your planning documents
4. Configure Cursor (see \`SETUP_CURSOR.md\` in the archive)

### Usage

Run the server:
\`\`\`bash
node dist/index.js
\`\`\`

Or configure Cursor to use it automatically.

See [INSTALLATION.md](https://github.com/${repo.owner}/${repo.repo}/blob/main/INSTALLATION.md) for detailed instructions.`;
            
            const fullReleaseBody = releaseBody + installationSection;
            
            // Write to file for use with body_path
            fs.writeFileSync('release_body.md', fullReleaseBody);
            
            // Set outputs
            core.setOutput('name', releaseName);
            console.log(`Release name: ${releaseName}`);
            console.log(`Release body length: ${fullReleaseBody.length} characters`);

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.TAG }}
          name: ${{ steps.release_notes.outputs.name }}
          body_path: release_body.md
          files: |
            artifacts/**/*
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, '-') }}
